<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Nomalization.css -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css" />
    <!-- socket.io -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js"></script>
    <!-- jquery -->
    <script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
    <!-- bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css">
    <!-- CSS -->
    <link rel="stylesheet" href="./css/chat.css">
    <!-- fontawesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css" integrity="sha512-xh6O/CkQoPOWDdYTDqeRdPCVd1SpvCA9XXcUnZS2FmJNp1coAFzvtCN9BmamE+4aHK8yyUHUSCcJHgXloTyT2A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <title>SeSAC Chat!ğŸŒ±</title>
</head>
<body>
    <!-- Navbar -->
    <div class="nav_box">
        <nav class="navbar navbar-expand-lg bg-light">
            <div class="container-fluid">
              <a class="navbar-brand" href="#">ğŸŒ±SeSAC ChatğŸŒ±</a>
              <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
              </button>
              <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                <div class="navbar-nav">
                    <a class="nav-link" aria-current="page" href="http://localhost:8000/">Home</a>
                    <a class="nav-link" onclick="creatRoom();">CreateRoom</a>
                </div>
              </div>
            </div>
        </nav>
    </div>
    <div class="chat_box">
        <div class="wrap">
            <div class="chatRoom">
                ì±„íŒ…ë°© ë¦¬ìŠ¤íŠ¸ 
            </div>
            <div id="chat-list" class="chat-list"></div>
            <div style="display: none;" id="name"><%=name %></div>
            
            <!-- í™ˆë²„íŠ¼ -->
            <!-- <div class="goHome">
                <button class="btn btn-secondary w-auto" type="button" onclick="goHome()">
                    <i class="fa-solid fa-house"></i>
                </button>
            </div> -->
        </div>
        <div class="input_box">
            <select id="nick-list">
                <option value="ì „ì²´">ì „ì²´</option>
            </select>
            <input type="text" placeholder="ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" id="message" onKeypress="javascript:if(event.keyCode==13){send();}">
            <button type="button" onclick="send();" class="btn btn-light w-auto">ì „ì†¡</button>
        </div>
    </div>
    <script>
        function creatRoom() {
            console.log('ì¢‹ì•„'); 
        }

        // í™ˆ ì´ë™ ë²„íŠ¼
        function goHome() {
            document.location.href="http://localhost:8000/";
        };

        var id = '';
        var nickname = document.getElementById('name').innerText;
        var socket = io.connect();
        socket.on('info', function(data) {id = data;})
        socket.emit('info2', { nickname })
        // ì•„ì´ë”” ë°›ì•„ì¤Œ

        function send(){
            console.log(id);
            let msg = document.getElementById('message').value;
            let nick = document.getElementById('nick-list').value;
            // ë©”ì„¸ì§€, ë‹‰ë„¤ì„ ê°’ ë³´ë‚´ì¤Œ
            socket.emit('send', {msg, to : nick});
            document.getElementById('message').value = '';
        }

        socket.on('newMessage', function(data) {
            // data = {id: ~~~. msg: ~~~~ , name : ~~ };
            let chat_list = document.getElementById('chat-list'); 
            let div = document.createElement('div');
            let div_chat = document.createElement('div');
            let span = document.createElement('span');

            div_chat.textContent = data.msg; // ë°•ìŠ¤ ì•ˆì— ë‹‰ë„¤ì„ : ë©”ì„¸ì§€ ë„£ì–´ì¤Œ 

            console.log(data);
            if (data.is_dm) span.textContent = span.textContent+ "(DM)";
            // data.id ë©”ì„¸ì§€ ë³´ë‚¸ ì‚¬ëŒ ì•„ì´ë””, id ë‚´ ì•„ì´ë”” 
            if (data.nickname == nickname) {
                span.textContent = data.to + span.textContent; 
                span.classList.add('nickname');
                div.appendChild(span);
                div.classList.add('my-chat');
            } else {
                span.textContent = data.nickname + span.textContent;
                span.classList.add('nickname');
                div.appendChild(span);
                div.classList.add('other-chat');
            }
            
            div.appendChild(div_chat); // appendë¡œ ì±—ë°•ìŠ¤ì•ˆì— ìì‹ìš”ì†Œë¡œ ë„£ì–´ì¤Œ
            chat_list.appendChild(div); // appendë¡œ ì±—ë°•ìŠ¤ì•ˆì— ìì‹ìš”ì†Œë¡œ ë„£ì–´ì¤Œ
        })

        // ì…&í‡´ì¥ ì•Œë¦¼
        socket.on('notice', function(data) {
            // data = {nickname: nickname , msg:'ë‹˜ì´ ì…ì¥or í‡´ì¥í•˜ì…¨ìŠµë‹ˆë‹¤.'}
            let chat_list = document.getElementById('chat-list'); 
            let div = document.createElement('div');
            div.textContent = data.nickname + data.msg;

            div.classList.add('access')
            chat_list.appendChild(div);
        })

        // ëª¨ë“  ìœ ì €ì •ë³´ ë°›ê¸° 
        socket.on('list', function(list) {
            // list = {id~~:nickname , id~~: nickname}
            let nick_list = document.getElementById('nick-list'); 
            while (nick_list.firstChild) {
                nick_list.removeChild(nick_list.lastChild); 
                // ê°€ì¥ëì— ìˆëŠ” ì˜µì…˜ë¶€í„° í•˜ë‚˜ì”© ì§€ì›Œì„œ ëª¨ë“  ì˜µì…˜ì„ ì§€ìš°ê¸°(ìì‹ìš”ì†Œ ì—†ì• ê¸°)
            }
            let option = document.createElement('option'); 
            option.text = 'ì „ì²´'; 
            option.value = 'ì „ì²´'; 
            nick_list.appendChild( option );
            // ì „ì²´ ì˜µì…˜ í•˜ë‚˜ë§Œ ìƒì„±
        
            for (let [key, value] of Object.entries(list) ) {
                // key = 'id', value='nickname';
                let option = document.createElement('option'); 
                option.text = value; 
                option.value = value; 
                nick_list.appendChild( option );
            }
        });
    </script>
</body>
</html>

